// МодульОбъектаОбработки: ws64_Монитор
// Описание: Монитор для отслеживания прогресса задач с использованием счетчиков и статусов
// Автор: Валерий
// Дата создания: 2025-04-29
// Версия: v1.4
// Зависимости: ws64_Счетчик, ws64_Логгер

#Область ОписаниеПеременных

Перем Счетчики; // Соответствие: Имя -> ОбработкаОбъект.ws64_Счетчик
Перем Статусы; // Соответствие: Имя -> Значение (строка, дата, число)
Перем Порядок; // Массив строк вида <Тип>.<Ключ>, порядок вывода
Перем ОбычноеПриложение; // Булево, признак обычного приложения
Перем ФоновыйРежим; // Булево, признак фонового режима
Перем Логгер; // ОбработкаОбъект.ws64_Логгер, Null - Объект для логирования, если задан

#КонецОбласти

#Область ПрограммныйИнтерфейс

// Устанавливает или возвращает фоновый режим.
// Параметры:
//   НовоеЗначение - Булево, Null - Новый режим. Если Null, возвращается текущий режим.
// Возвращаемое значение:
//   Булево - Текущий режим (если Null).
//   ЭтотОбъект - Для цепочки вызовов (если указано значение).
Функция ФоновыйРежим(НовоеЗначение = Null) Экспорт
    Если НовоеЗначение = Null Тогда
        Возврат ФоновыйРежим;
    КонецЕсли;
    ФоновыйРежим = Булево(НовоеЗначение);
    Возврат ЭтотОбъект;
КонецФункции

// Устанавливает или возвращает статус по ключу.
// Параметры:
//   Ключ - Строка - Идентификатор статуса.
//   НовоеЗначение - Произвольный, Null - Новое значение статуса. Если Null, возвращается текущее значение.
// Возвращаемое значение:
//   Произвольное - Текущее значение статуса (если Null, возвращает Неопределено, если ключа нет).
//   ЭтотОбъект - Для цепочки вызовов (если указано значение).
Функция Статус(Ключ, НовоеЗначение = Null) Экспорт
    Если ПустаяСтрока(Ключ) Тогда
        ВызватьИсключение "Ключ статуса не может быть пустым.";
    КонецЕсли;
    Если НовоеЗначение = Null Тогда
        Возврат Статусы[Ключ]; // Безопасно возвращает Неопределено при отсутствии ключа
    КонецЕсли;
    Статусы[Ключ] = НовоеЗначение; // Безопасно добавляет или перезаписывает
    Порядок(Ключ, "Статус");
    Возврат ЭтотОбъект;
КонецФункции

// Возвращает счетчик по ключу, создавая новый с настройками по умолчанию, если его нет.
// Параметры:
//   Ключ - Строка - Идентификатор счетчика.
// Возвращаемое значение:
//   ОбработкаОбъект.ws64_Счетчик - Существующий или новый счетчик.
Функция Счетчик(Ключ) Экспорт
    Если ПустаяСтрока(Ключ) Тогда
        ВызватьИсключение "Ключ счетчика не может быть пустым.";
    КонецЕсли;
    СчетчикОбъект = Счетчики[Ключ];
    Если СчетчикОбъект = Неопределено Тогда
        СчетчикОбъект = Обработки.ws64_Счетчик.Создать()
            .Минимум(0)
            .Максимум(Неопределено)
            .ИнтервалОбновления(1000)
            .Описание("")
            .Инициализация();
        Счетчики[Ключ] = СчетчикОбъект;
        Порядок(Ключ, "Счетчик");
    КонецЕсли;
    Возврат СчетчикОбъект;
КонецФункции

// Устанавливает или возвращает объект логгера.
// Параметры:
//   НовыйЛоггер - ОбработкаОбъект.ws64_Логгер, Null - Новый объект логгера. Если Null, возвращается текущий логгер.
//                  Если не задан и логгер не инициализирован, создаётся новый с настройками по умолчанию.
// Возвращаемое значение:
//   ОбработкаОбъект.ws64_Логгер - Текущий логгер (существующий или новый).
//   ЭтотОбъект - Для цепочки вызовов (если указано значение).
Функция Логгер(НовыйЛоггер = Null) Экспорт
    Если НовыйЛоггер = Null Тогда
        Если Логгер = Неопределено Тогда
            Логгер = Обработки.ws64_Логгер.Создать(); // Создаём логгер по умолчанию
        КонецЕсли;
        Возврат Логгер;
    КонецЕсли;
    Если ТипЗнч(НовыйЛоггер) <> Тип("ОбработкаОбъект.ws64_Логгер") Тогда
        ВызватьИсключение "Ожидается логгер типа ws64_Логгер.";
    КонецЕсли;
    Логгер = НовыйЛоггер;
    Возврат ЭтотОбъект;
КонецФункции

// Удаляет счетчик или статус по ключу.
// Параметры:
//   Ключ - Строка - Идентификатор элемента.
//   Тип - Строка - Тип элемента ("Счетчик" или "Статус", по умолчанию "").
// Возвращаемое значение:
//   ЭтотОбъект - Для цепочки вызовов.
Функция Очистить(Ключ, Тип = "") Экспорт
    Если ПустаяСтрока(Ключ) Тогда
        ЗначенияПоУмолчаню();
        Возврат ЭтотОбъект;
    КонецЕсли;
    Если Тип = "Счетчик" Или ПустаяСтрока(Тип) Тогда
        Счетчики.Удалить(Ключ);
    КонецЕсли;
    Если Тип = "Статус" Или ПустаяСтрока(Тип) Тогда
        Статусы.Удалить(Ключ);
    КонецЕсли;
    Индекс = Порядок.Найти("Счетчик." + Ключ);
    Если Индекс <> Неопределено Тогда
        Порядок.Удалить(Индекс);
    КонецЕсли;
    Возврат ЭтотОбъект;
КонецФункции

// Перемещает ключ в конец массива Порядок для актуализации порядка вывода.
// Параметры:
//   Ключ - Строка - Идентификатор счетчика или статуса.
//   Тип - Строка - Тип элемента ("Счетчик" или "Статус").
Процедура Порядок(Ключ, Тип) Экспорт
    Элемент = Тип + "." + Ключ;
    Индекс = Порядок.Найти(Элемент);
    Если Индекс <> Неопределено Тогда
        Порядок.Удалить(Индекс);
    КонецЕсли;
    Структура = ?(Тип = "Счетчик", Счетчики, Статусы);
    Если Структура[Ключ] <> Неопределено Тогда
        Порядок.Добавить(Элемент);
    КонецЕсли;
КонецПроцедуры

// Синхронизирует Порядок с ключами из Счетчики и Статусы.
// Возвращаемое значение:
//   ЭтотОбъект - Для цепочки вызовов.
Функция СинхронизироватьПорядок() Экспорт
    Порядок.Очистить();
    Для Каждого Элемент Из Счетчики Цикл
        Порядок(Элемент.Ключ, "Счетчик");
    КонецЦикла;
    Для Каждого Элемент Из Статусы Цикл
        Порядок(Элемент.Ключ, "Статус");
    КонецЦикла;
    Возврат ЭтотОбъект;
КонецФункции

// Возвращает строковое представление монитора.
// Параметры:
//   Разделитель - Строка, Null - Разделитель строк (по умолчанию Символы.ПС).
// Возвращаемое значение:
//   Строка - Формат: "<Ключ1>: <Значение1><Разделитель><Ключ2>: <Значение2>..."
Функция Строкой(Разделитель = Null) Экспорт
    Строки = Новый Массив;
    Если Разделитель = Null Тогда
        Разделитель = Символы.ПС;
    КонецЕсли;
    Для Каждого Элемент Из Порядок Цикл
        Части = СтрРазделить(Элемент, ".");
        Тип = Части[0];
        Ключ = Части[1];
        Структура = ?(Тип = "Счетчик", Счетчики, Статусы);
        Если Структура[Ключ] <> Неопределено Тогда
            Значение = Структура[Ключ];
            Если Тип = "Счетчик" Тогда
                Строки.Добавить(Ключ + ": " + Значение.Строкой());
            ИначеЕсли ТипЗнч(Значение) = Тип("Дата") Тогда
                Строки.Добавить(Ключ + ": " + Формат(Значение, "ДЛФ=DT"));
            ИначеЕсли ТипЗнч(Значение) = Тип("Число") Тогда
                Строки.Добавить(Ключ + ": " + Формат(Значение, "ЧГ="));
            Иначе
                Строки.Добавить(Ключ + ": " + Строка(Значение));
            КонецЕсли;
        КонецЕсли;
    КонецЦикла;
    Возврат СтрСоединить(Строки, Разделитель);
КонецФункции

// Сохраняет данные монитора в текстовый файл.
// Параметры:
//   ИмяФайла - Строка - Полный путь к файлу.
// Возвращаемое значение:
//   ЭтотОбъект - Для цепочки вызовов.
Функция СохранитьВФайл(ИмяФайла) Экспорт
    Текст = Строкой();
    Запись = Новый ЗаписьТекста(ИмяФайла, КодировкаТекста.UTF8);
    Запись.Записать(Текст);
    Запись.Закрыть();
    Возврат ЭтотОбъект;
КонецФункции

// Выводит данные монитора в строку состояния (только в обычном приложении).
// Возвращаемое значение:
//   ЭтотОбъект - Для цепочки вызовов.
Функция ВывестиВСостояние() Экспорт
    Если Не ФоновыйРежим И ОбычноеПриложение Тогда
        Выполнить("Состояние(Строкой("" ""))");
    КонецЕсли;
    Возврат ЭтотОбъект;
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Устанавливает значения по умолчанию для переменных монитора.
Процедура ЗначенияПоУмолчаню()
    Счетчики = Новый Соответствие;
    Статусы = Новый Соответствие;
    Порядок = Новый Массив;
    ОбычноеПриложение = ТекущийРежимЗапуска() = РежимЗапускаКлиентскогоПриложения.ОбычноеПриложение;
    ФоновыйРежим = Ложь;
    Логгер = Неопределено;
КонецПроцедуры

#КонецОбласти

#Область Тесты

// Тесты для проверки корректности работы монитора
Процедура Тест() Экспорт
    Ошибки = Новый Массив;
    
    Тест1(Ошибки);
    Тест2(Ошибки);
    Тест3(Ошибки);
    Тест4(Ошибки);
    Тест5(Ошибки); // Новый тест для Логгера
    
    // Итоги тестирования
    Если Ошибки.Количество() = 0 Тогда
        Сообщить("ws64_Монитор: Все тесты пройдены успешно");
    Иначе
        Сообщить("ws64_Монитор: Обнаружены ошибки" + Символы.ПС + СтрСоединить(Ошибки, Символы.ПС));
    КонецЕсли;
КонецПроцедуры

// Тест 1: Проверка инициализации монитора
// Параметры:
//   Ошибки - Массив - Массив для добавления описаний ошибок при неудачном тесте.
Процедура Тест1(Ошибки)
    Монитор = Обработки.ws64_Монитор.Создать()
        .ФоновыйРежим(Ложь);
    Если Монитор.ФоновыйРежим() <> Ложь Тогда
        Ошибки.Добавить("Тест 1: Ошибка инициализации фонового режима");
    КонецЕсли;
КонецПроцедуры

// Тест 2: Проверка установки и получения статуса
// Параметры:
//   Ошибки - Массив - Массив для добавления описаний ошибок при неудачном тесте.
Процедура Тест2(Ошибки)
    Монитор = Обработки.ws64_Монитор.Создать()
        .Статус("Состояние", "В процессе");
    Если Монитор.Статус("Состояние") <> "В процессе" Тогда
        Ошибки.Добавить("Тест 2: Ошибка установки статуса");
    КонецЕсли;
КонецПроцедуры

// Тест 3: Проверка добавления счетчика
// Параметры:
//   Ошибки - Массив - Массив для добавления описаний ошибок при неудачном тесте.
Процедура Тест3(Ошибки)
    Монитор = Обработки.ws64_Монитор.Создать();
    Счетчик = Монитор.Счетчик("Товары");
    Если Монитор.Счетчик("Товары") <> Счетчик Тогда
        Ошибки.Добавить("Тест 3: Ошибка добавления счетчика");
    КонецЕсли;
    Если Счетчик.Минимум() <> 0 Или Счетчик.Максимум() <> Неопределено Или Счетчик.ИнтервалОбновления() <> 1000 Или Счетчик.Описание() <> "" Тогда
        Ошибки.Добавить("Тест 3: Ошибка установки значений по умолчанию для счетчика");
    КонецЕсли;
КонецПроцедуры

// Тест 4: Проверка вывода строки
// Параметры:
//   Ошибки - Массив - Массив для добавления описаний ошибок при неудачном тесте.
Процедура Тест4(Ошибки)
    Монитор = Обработки.ws64_Монитор.Создать()
        .Статус("Состояние", "В процессе");
    Счетчик = Монитор.Счетчик("Товары");
    ОжидаемаяСтрока = "Состояние: В процессе" + Символы.ПС + "Товары: 1000:0: Счетчик без максимума Выполнено: 0%";
    Если Монитор.Строкой() <> ОжидаемаяСтрока Тогда
        Ошибки.Добавить("Тест 4: Ошибка формирования строки");
    КонецЕсли;
КонецПроцедуры

// Тест 5: Проверка установки и получения логгера
// Параметры:
//   Ошибки - Массив - Массив для добавления описаний ошибок при неудачном тесте.
Процедура Тест5(Ошибки)
    Монитор = Обработки.ws64_Монитор.Создать()
        .Логгер(); // Создаём логгер по умолчанию
    Если ТипЗнч(Монитор.Логгер()) <> Тип("ОбработкаОбъект.ws64_Логгер") Тогда
        Ошибки.Add("Тест 5: Ошибка создания логгера по умолчанию");
    КонецЕсли;
    ЛоггерОбъект = Обработки.ws64_Логгер.Создать();
    Монитор.Логгер(ЛоггерОбъект);
    Если Монитор.Логгер() <> ЛоггерОбъект Тогда
        Ошибки.Add("Тест 5: Ошибка установки пользовательского логгера");
    КонецЕсли;
КонецПроцедуры

#КонецОбласти

#Область Инициализация

ЗначенияПоУмолчаню();

#КонецОбласти